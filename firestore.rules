rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ✅ Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isShopOwner(shopId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/shops/$(shopId)).data.user_id == request.auth.uid;
    }
    
    // ✅ Shops
    match /shops/{shopId} {
      allow read, write: if isShopOwner(shopId);
    }
    
    // ✅ Employees
    match /employees/{employeeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isShopOwner(request.resource.data.shop_id);
    }
    
    // ✅ Customers
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isShopOwner(request.resource.data.shop_id);
    }
    
    // ✅ Clock entries
    match /clock_entries/{entryId} {
      allow read: if isShopOwner(resource.data.shop_id) ||
                   resource.data.employee_id == request.auth.uid;
      allow create: if isAuthenticated();
      allow update, delete: if isShopOwner(resource.data.shop_id);
    }

    // ✅ Tasks
    match /tasks/{taskId} {
      allow read, create, update, delete: if isShopOwner(request.resource.data.shop_id);
    }

    // ✅ Task completions
    match /task_completions/{completionId} {
      allow read: if isAuthenticated();
      allow write: if isShopOwner(request.resource.data.shop_id) ||
                    request.auth.uid == request.resource.data.employee_id;
    }

    // ✅ Incidents
    match /incidents/{incidentId} {
      allow read: if isShopOwner(resource.data.shop_id);
      allow create: if isAuthenticated();
      allow update, delete: if isShopOwner(resource.data.shop_id);
    }

    // ✅ Appointments
    match /appointments/{appointmentId} {
      allow read: if isShopOwner(resource.data.shop_id);
      allow create, update, delete: if isShopOwner(request.resource.data.shop_id);
    }

    // ✅ Flash offers
    match /flash_offers/{offerId} {
      allow read: if true; // Public
      allow write: if isShopOwner(request.resource.data.shop_id);
    }

    // ✅ Loyalty transactions
    match /loyalty_transactions/{txnId} {
      allow read: if isShopOwner(resource.data.shop_id) ||
                   resource.data.customer_id == request.auth.uid;
      allow write: if isShopOwner(request.resource.data.shop_id);
    }

    // ✅ Clock-in requests
    match /clock_in_requests/{reqId} {
      allow read: if isShopOwner(resource.data.shop_id);
      allow create: if isAuthenticated();
      allow update, delete: if isShopOwner(resource.data.shop_id);
    }
  }
}
